---
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachineDeployment
metadata:
  name: "${CLUSTER_NAME}-azl3-md-0"
spec:
  clusterName: "${CLUSTER_NAME}"
  replicas: ${AZL3_WORKER_MACHINE_COUNT:=2}
  selector:
    matchLabels:
  template:
    spec:
      clusterName: "${CLUSTER_NAME}"
      version: "${KUBERNETES_VERSION}"
      bootstrap:
        configRef:
          name: "${CLUSTER_NAME}-azl3-md-0"
          apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
          kind: KubeadmConfigTemplate
      infrastructureRef:
        name: "${CLUSTER_NAME}-azl3-md-0"
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: AzureMachineTemplate
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AzureMachineTemplate
metadata:
  name: "${CLUSTER_NAME}-azl3-md-0"
spec:
  template:
    spec:
      vmSize: ${AZURE_NODE_MACHINE_TYPE}
      osDisk:
        osType: "Linux"
        diskSizeGB: 128
      sshPublicKey: ${AZURE_SSH_PUBLIC_KEY_B64:=""}
      image:
        computeGallery:
          gallery: ClusterAPI-f72ceb4f-5159-4c26-a0fe-2ea738f0d019
          name: capi-azurelinux-3
          version: ${AZL3_VERSION:="1.33.2"}
---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: "${CLUSTER_NAME}-azl3-md-0"
spec:
  template:
    spec:
      files:
      - content: |
          #!/bin/bash

          set -o nounset
          set -o pipefail
          set -o errexit

          # Install ca-certificates packages for Azure Linux
          tdnf install -y ca-certificates ca-certificates-legacy
          update-ca-trust

          # Follow Azure Linux 3 docs exactly - completely permissive for debugging
          # Change default policy to ACCEPT (as recommended by AZL3 docs)
          iptables -P INPUT ACCEPT
          iptables -P FORWARD ACCEPT
          iptables -P OUTPUT ACCEPT

          ip6tables -P INPUT ACCEPT
          ip6tables -P FORWARD ACCEPT
          ip6tables -P OUTPUT ACCEPT

          # Flush any rules which would filter packets
          iptables -F
          ip6tables -F

          iptables-save > /etc/systemd/scripts/ip4save
          ip6tables-save > /etc/systemd/scripts/ip6save
        path: /tmp/azl3-setup.sh
        owner: "root:root"
        permissions: "0744"
      - contentFrom:
          secret:
            name: ${CLUSTER_NAME}-azl3-md-0-azure-json
            key: worker-node-azure.json
        owner: root:root
        path: /etc/kubernetes/azure.json
        permissions: "0644"
      - content: |
          #!/bin/bash

          set -o nounset
          set -o pipefail
          set -o errexit

          export KUBEADM_REVISION="${KUBEADM_REVISION:-""}"
          export KUBECTL_REVISION="${KUBECTL_REVISION:-""}"
          export KUBELET_REVISION="${KUBELET_REVISION:-""}"

          systemctl stop kubelet

          BASE_URL="https://kubernetesreleases.blob.core.windows.net/dalec-packages"
          VERSION="${KUBERNETES_VERSION}"
          VERSION=$${VERSION#v}
          OS_VERSION="azl3"
          ARCH="x86_64"

          # Build lists of binaries to replace based on what's set
          declare -a BINARIES=()
          declare -A RPM_RELEASES=()

          [[ -n "${KUBEADM_REVISION}" ]] && BINARIES+=("kubeadm") && RPM_RELEASES["kubeadm"]="$${KUBEADM_REVISION}.$${OS_VERSION}"
          [[ -n "${KUBECTL_REVISION}" ]] && BINARIES+=("kubectl") && RPM_RELEASES["kubectl"]="$${KUBECTL_REVISION}.$${OS_VERSION}"
          [[ -n "${KUBELET_REVISION}" ]] && BINARIES+=("kubelet") && RPM_RELEASES["kubelet"]="$${KUBELET_REVISION}.$${OS_VERSION}"

          # Skip if nothing to replace (check first element)
          if [[ -z "$${BINARIES[0]:-}" ]]; then
            echo "No *_REVISION variables set. Skipping binary replacement."
            systemctl start kubelet
            exit 0
          fi

          echo "Replacing binaries: $${BINARIES[*]}"

          for BINARY in "$${BINARIES[@]}"; do
            RPM_RELEASE="$${RPM_RELEASES[$${BINARY}]}"
            echo "* downloading and extracting binary: $${BINARY} $${VERSION} with rpm release $${RPM_RELEASE}"
            RPM_FILE="/tmp/$${BINARY}-$${VERSION}-$${RPM_RELEASE}.$${ARCH}.rpm"
            RPM_URL="$${BASE_URL}/$${BINARY}/$${VERSION}/$${OS_VERSION}/$${ARCH}/$${BINARY}-$${VERSION}-$${RPM_RELEASE}.$${ARCH}.rpm"

            echo "Downloading from: $${RPM_URL}"
            curl -L --retry 10 --retry-delay 5 "$${RPM_URL}" --output "$${RPM_FILE}"

            echo "Extracting $${BINARY} binary to /usr/bin"
            TEMP_DIR="/tmp/$${BINARY}-extract-$$"
            mkdir -p "$${TEMP_DIR}"
            cd "$${TEMP_DIR}"
            rpm2cpio "$${RPM_FILE}" | cpio -idmv

            if [ -f "./usr/bin/$${BINARY}" ]; then
              mv "./usr/bin/$${BINARY}" "/usr/bin/$${BINARY}"
              chmod +x "/usr/bin/$${BINARY}"
            else
              echo "Error: Binary $${BINARY} not found in RPM package"
              exit 1
            fi

            cd /
            rm -rf "$${TEMP_DIR}"
            rm -f "$${RPM_FILE}"
          done

          systemctl restart kubelet

          # Print versions
          [[ " $${BINARIES[*]} " =~ " kubeadm " ]] && echo "kubeadm version: $(kubeadm version -o=short)"
          [[ " $${BINARIES[*]} " =~ " kubectl " ]] && echo "kubectl version: $(kubectl version --client=true)"
          [[ " $${BINARIES[*]} " =~ " kubelet " ]] && echo "kubelet version: $(kubelet --version)"
        path: /opt/install-custom-k8s-binaries.sh
        owner: "root:root"
        permissions: "0744"
      preKubeadmCommands:
      - bash -c /tmp/azl3-setup.sh
      - echo '${AZURE_INTERNAL_LB_PRIVATE_IP}   ${CLUSTER_NAME}-${APISERVER_LB_DNS_SUFFIX}.${AZURE_LOCATION}.cloudapp.azure.com' >> /etc/hosts
      - bash -c /opt/install-custom-k8s-binaries.sh
      joinConfiguration:
        nodeRegistration:
          name: '{{ ds.meta_data["local_hostname"] }}'
          kubeletExtraArgs:
            cloud-provider: external
