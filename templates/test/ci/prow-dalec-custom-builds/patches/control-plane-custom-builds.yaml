- op: add
  path: /spec/kubeadmConfigSpec/files/-
  value:
    content: |
      #!/bin/bash
      set -o nounset
      set -o pipefail
      set -o errexit

      export KUBEADM_REVISION="${KUBEADM_REVISION:-""}"
      export KUBECTL_REVISION="${KUBECTL_REVISION:-""}"
      export KUBELET_REVISION="${KUBELET_REVISION:-""}"

      BASE_URL="https://kubernetesreleases.blob.core.windows.net/dalec-packages"
      VERSION="${DALEC_KUBERNETES_VERSION}"
      VERSION=$${VERSION#v}
      OS_VERSION="ubuntu24.04"
      ARCH="amd64"

      # Check if ANY revision is set - if so, we need to replace ALL binaries
      # to ensure version consistency (kubeadm requires all components to be same version)
      ANY_REVISION_SET="false"
      [[ -n "${KUBEADM_REVISION}" ]] && ANY_REVISION_SET="true"
      [[ -n "${KUBECTL_REVISION}" ]] && ANY_REVISION_SET="true"
      [[ -n "${KUBELET_REVISION}" ]] && ANY_REVISION_SET="true"

      if [[ "$${ANY_REVISION_SET}" != "true" ]]; then
        echo "No *_REVISION variables set. Skipping binary replacement."
        exit 0
      fi

      echo "At least one revision is set. Replacing ALL binaries to ensure version consistency."
      systemctl stop kubelet

      # All binaries that must be replaced for version consistency
      ALL_BINARIES=("kubeadm" "kubectl" "kubelet")

      # Function to find an available revision for a binary
      find_available_revision() {
        local binary="$$1"
        local base_url="$$2"
        local version="$$3"
        local os_version="$$4"
        local arch="$$5"

        # Try revisions from 10 down to 1
        for rev in $(seq 10 -1 1); do
          local deb_version="$${os_version}u$${rev}"
          local deb_url="$${base_url}/$${binary}/$${version}/$${os_version}/$${arch}/$${binary}_$${version}-$${deb_version}_$${arch}.deb"
          if curl --head --silent --fail "$${deb_url}" > /dev/null 2>&1; then
            echo "$${rev}"
            return 0
          fi
        done
        return 1
      }

      for BINARY in "$${ALL_BINARIES[@]}"; do
        # Get the revision for this binary (from env var or find available)
        REVISION=""
        case "$${BINARY}" in
          kubeadm) REVISION="${KUBEADM_REVISION}" ;;
          kubectl) REVISION="${KUBECTL_REVISION}" ;;
          kubelet) REVISION="${KUBELET_REVISION}" ;;
        esac

        if [[ -z "$${REVISION}" ]]; then
          echo "* $${BINARY}: no revision specified, finding available revision..."
          REVISION=$(find_available_revision "$${BINARY}" "$${BASE_URL}" "$${VERSION}" "$${OS_VERSION}" "$${ARCH}" || true)
          if [[ -z "$${REVISION}" ]]; then
            echo "ERROR: Could not find any available revision for $${BINARY} version $${VERSION}"
            exit 1
          fi
          echo "* $${BINARY}: found available revision $${REVISION}"
        fi

        DEB_VERSION="$${OS_VERSION}u$${REVISION}"
        echo "* downloading and extracting binary: $${BINARY} $${VERSION} with deb version $${DEB_VERSION}"
        DEB_FILE="/tmp/$${BINARY}_$${VERSION}-$${DEB_VERSION}_$${ARCH}.deb"
        DEB_URL="$${BASE_URL}/$${BINARY}/$${VERSION}/$${OS_VERSION}/$${ARCH}/$${BINARY}_$${VERSION}-$${DEB_VERSION}_$${ARCH}.deb"
        echo "Downloading from: $${DEB_URL}"
        curl -L --retry 10 --retry-delay 5 "$${DEB_URL}" --output "$${DEB_FILE}"
        echo "Extracting $${BINARY} binary to /usr/bin"
        dpkg-deb --fsys-tarfile "$${DEB_FILE}" | tar -xf - --strip-components=3 -C /usr/bin ./usr/bin/$${BINARY}
        chmod +x "/usr/bin/$${BINARY}"
        rm -f "$${DEB_FILE}"
      done

      systemctl restart kubelet

      # Print versions
      echo "kubeadm version: $(kubeadm version -o=short)"
      echo "kubectl version: $(kubectl version --client=true)"
      echo "kubelet version: $(kubelet --version)"
    path: /tmp/replace-k8s-binaries.sh
    owner: "root:root"
    permissions: "0744"
# Add /etc/hosts entry for API server FQDN to work around Azure ILB hairpin routing issue.
# - If API server is reachable via ILB: This is a join node, use ILB IP
# - If API server is NOT reachable: This is the init node, use localhost (API server will run locally)
# This MUST run before any other preKubeadmCommands that might need API server access.
- op: add
  path: /spec/kubeadmConfigSpec/preKubeadmCommands/0
  value:
    bash -c 'if curl -sk --connect-timeout 5 https://${AZURE_INTERNAL_LB_PRIVATE_IP}:6443/healthz >/dev/null 2>&1; then echo "${AZURE_INTERNAL_LB_PRIVATE_IP}   ${CLUSTER_NAME}-${APISERVER_LB_DNS_SUFFIX}.${AZURE_LOCATION}.cloudapp.azure.com" >> /etc/hosts; else echo "127.0.0.1   ${CLUSTER_NAME}-${APISERVER_LB_DNS_SUFFIX}.${AZURE_LOCATION}.cloudapp.azure.com" >> /etc/hosts; fi'
- op: add
  path: /spec/kubeadmConfigSpec/preKubeadmCommands/-
  value:
    bash -c /tmp/replace-k8s-binaries.sh
- op: add
  path: /spec/kubeadmConfigSpec/initConfiguration/nodeRegistration/ignorePreflightErrors
  value:
    - HTTPProxyCIDR
  