- op: add
  path: /spec/template/spec/files/-
  value:
    content: |
      #!/bin/bash
      set -o nounset
      set -o pipefail
      set -o errexit

      export KUBEADM_REVISION="${KUBEADM_REVISION:-""}"
      export KUBECTL_REVISION="${KUBECTL_REVISION:-""}"
      export KUBELET_REVISION="${KUBELET_REVISION:-""}"

      systemctl stop kubelet

      BASE_URL="https://kubernetesreleases.blob.core.windows.net/dalec-packages"
      VERSION="${KUBERNETES_VERSION}"
      VERSION=$${VERSION#v}
      OS_VERSION="ubuntu24.04"
      ARCH="amd64"

      # Build lists of binaries to replace based on what's set
      declare -a BINARIES=()
      declare -A DEB_VERSIONS=()

      [[ -n "${KUBEADM_REVISION}" ]] && BINARIES+=("kubeadm") && DEB_VERSIONS["kubeadm"]="$${OS_VERSION}u$${KUBEADM_REVISION}"
      [[ -n "${KUBECTL_REVISION}" ]] && BINARIES+=("kubectl") && DEB_VERSIONS["kubectl"]="$${OS_VERSION}u$${KUBECTL_REVISION}"
      [[ -n "${KUBELET_REVISION}" ]] && BINARIES+=("kubelet") && DEB_VERSIONS["kubelet"]="$${OS_VERSION}u$${KUBELET_REVISION}"

      # Skip if nothing to replace (check first element)
      if [[ -z "$${BINARIES[0]:-}" ]]; then
        echo "No *_REVISION variables set. Skipping binary replacement."
        systemctl start kubelet
        exit 0
      fi

      echo "Replacing binaries: $${BINARIES[*]}"

      for BINARY in "$${BINARIES[@]}"; do
        DEB_VERSION="$${DEB_VERSIONS[$${BINARY}]}"
        echo "* downloading and extracting binary: $${BINARY} $${VERSION} with deb version $${DEB_VERSION}"
        DEB_FILE="/tmp/$${BINARY}_$${VERSION}-$${DEB_VERSION}_$${ARCH}.deb"
        DEB_URL="$${BASE_URL}/$${BINARY}/$${VERSION}/$${OS_VERSION}/$${ARCH}/$${BINARY}_$${VERSION}-$${DEB_VERSION}_$${ARCH}.deb"
        echo "Downloading from: $${DEB_URL}"
        curl -L --retry 10 --retry-delay 5 "$${DEB_URL}" --output "$${DEB_FILE}"
        echo "Extracting $${BINARY} binary to /usr/bin"
        dpkg-deb --fsys-tarfile "$${DEB_FILE}" | tar -xf - --strip-components=3 -C /usr/bin ./usr/bin/$${BINARY}
        chmod +x "/usr/bin/$${BINARY}"
        rm -f "$${DEB_FILE}"
      done

      systemctl restart kubelet

      # Print versions
      [[ " $${BINARIES[*]} " =~ " kubeadm " ]] && echo "kubeadm version: $(kubeadm version -o=short)"
      [[ " $${BINARIES[*]} " =~ " kubectl " ]] && echo "kubectl version: $(kubectl version --client=true)"
      [[ " $${BINARIES[*]} " =~ " kubelet " ]] && echo "kubelet version: $(kubelet --version)"
    path: /tmp/replace-k8s-binaries.sh
    owner: "root:root"
    permissions: "0744"
- op: add
  path: /spec/template/spec/preKubeadmCommands/-
  value:
    bash -c /tmp/replace-k8s-binaries.sh
