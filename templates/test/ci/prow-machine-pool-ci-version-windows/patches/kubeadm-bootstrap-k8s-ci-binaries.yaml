- op: add
  path: /spec/files/0
  value:
    path: /tmp/kubeadm-bootstrap.sh
    owner: "root:root"
    permissions: "0744"
    content: |
      #!/bin/bash

      set -o nounset
      set -o pipefail
      set -o errexit
      [[ $(id -u) != 0 ]] && SUDO="sudo" || SUDO=""

      # This test installs release packages or binaries that are a result of the CI and release builds.
      # It runs '... --version' commands to verify that the binaries are correctly installed
      # and finally uninstalls the packages.
      # For the release packages it tests all versions in the support skew.
      LINE_SEPARATOR="*************************************************"
      echo "$${LINE_SEPARATOR}"
      CI_VERSION=${CI_VERSION}

      # Note: We assume if kubectl has the right version, everything else has as well
      if [[ $(kubectl version --client=true -o json | jq '.clientVersion.gitVersion' -r) = "$${CI_VERSION}" ]]; then
        echo "Detected Kubernetes $${CI_VERSION} via kubectl version, nothing to do"
        exit 0
      fi
      if [[ "$${CI_VERSION}" != "" ]]; then
        CI_DIR=/tmp/k8s-ci
        mkdir -p "$${CI_DIR}"
        declare -a PACKAGES_TO_TEST=("kubectl" "kubelet" "kubeadm")
        # Let's just also download the control plane images for worker nodes. It's easier then optimizing it.
        declare -a CONTAINERS_TO_TEST=("kube-apiserver" "kube-controller-manager" "kube-proxy" "kube-scheduler")
        CONTAINER_EXT="tar"
        echo "* testing version $${CI_VERSION}"
        CI_URL="https://dl.k8s.io/ci/$${CI_VERSION}/bin/linux/amd64"
        # Set CI_URL to the released binaries for actually released versions.
        if [[ "$${CI_VERSION}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]] || [[ "$${CI_VERSION}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-(beta|rc).[0-9]+$ ]]; then
          CI_URL="https://dl.k8s.io/release/$${CI_VERSION}/bin/linux/amd64"
        fi
        for CI_PACKAGE in "$${PACKAGES_TO_TEST[@]}"; do
          # Browser: https://console.cloud.google.com/storage/browser/k8s-release-dev?project=k8s-release-dev
          # e.g.: https://storage.googleapis.com/k8s-release-dev/ci/v1.21.0-beta.1.378+cf3374e43491c5/bin/linux/amd64/kubectl
          echo "* downloading binary: $${CI_URL}/$${CI_PACKAGE}"
          wget --inet4-only "$${CI_URL}/$${CI_PACKAGE}" -O "$${CI_DIR}/$${CI_PACKAGE}"
          chmod +x "$${CI_DIR}/$${CI_PACKAGE}"
          mv "$${CI_DIR}/$${CI_PACKAGE}" "/usr/bin/$${CI_PACKAGE}"
        done

        systemctl restart kubelet
        IMAGE_REGISTRY_PREFIX=registry.k8s.io
        # Kubernetes builds from 1.20 through 1.24 are tagged with k8s.gcr.io
        if [[ "$${CI_VERSION}" =~ ^v1\.(1[0-9]|2[0-4])[\.[0-9]+ ]]; then
          IMAGE_REGISTRY_PREFIX=k8s.gcr.io
        fi
        for CI_CONTAINER in "$${CONTAINERS_TO_TEST[@]}"; do
          echo "* downloading package: $${CI_URL}/$${CI_CONTAINER}.$${CONTAINER_EXT}"
          wget --inet4-only "$${CI_URL}/$${CI_CONTAINER}.$${CONTAINER_EXT}" -O "$${CI_DIR}/$${CI_CONTAINER}.$${CONTAINER_EXT}"
          $${SUDO} ctr -n k8s.io images import "$${CI_DIR}/$${CI_CONTAINER}.$${CONTAINER_EXT}" || echo "* ignoring expected 'ctr images import' result"
          $${SUDO} ctr -n k8s.io images tag "$${IMAGE_REGISTRY_PREFIX}/$${CI_CONTAINER}-amd64:$${CI_VERSION//+/_}" "$${IMAGE_REGISTRY_PREFIX}/$${CI_CONTAINER}:$${CI_VERSION//+/_}"
          $${SUDO} ctr -n k8s.io images tag "$${IMAGE_REGISTRY_PREFIX}/$${CI_CONTAINER}-amd64:$${CI_VERSION//+/_}" "gcr.io/k8s-staging-ci-images/$${CI_CONTAINER}:$${CI_VERSION//+/_}"
        done
      fi
      echo "* checking binary versions"
      echo "ctr version: " "$(ctr version)"
      echo "kubeadm version: " "$(kubeadm version -o=short)"
      echo "kubectl version: " "$(kubectl version --client=true)"
      echo "kubelet version: " "$(kubelet --version)"
      echo "$${LINE_SEPARATOR}"
- op: add
  path: /spec/files/0
  value:
    path: /tmp/oot-cred-provider.sh
    owner: "root:root"
    permissions: "0744"
    content: |
      #!/bin/bash

      set -o nounset
      set -o pipefail
      set -o errexit
      [[ $(id -u) != 0 ]] && SUDO="sudo" || SUDO=""

      # Run the az login command with managed identity
      if az login --identity > /dev/null 2>&1; then
        echo "Logged in Azure with managed identity"
        echo "Use OOT credential provider"
        mkdir -p /var/lib/kubelet/credential-provider
        az storage blob download --blob-url "https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_BLOB_CONTAINER_NAME}/${IMAGE_TAG_ACR_CREDENTIAL_PROVIDER}/azure-acr-credential-provider" -f /var/lib/kubelet/credential-provider/acr-credential-provider --auth-mode login
        chmod 755 /var/lib/kubelet/credential-provider/acr-credential-provider
        az storage blob download --blob-url "https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_BLOB_CONTAINER_NAME}/${IMAGE_TAG_ACR_CREDENTIAL_PROVIDER}/credential-provider-config.yaml" -f /var/lib/kubelet/credential-provider-config.yaml --auth-mode login
        chmod 644 /var/lib/kubelet/credential-provider-config.yaml
      else
        echo "Using curl to download the OOT credential provider"
        mkdir -p /var/lib/kubelet/credential-provider
        curl --retry 10 --retry-delay 5 -w "response status code is %{http_code}" -Lo /var/lib/kubelet/credential-provider/acr-credential-provider "https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_BLOB_CONTAINER_NAME}/${IMAGE_TAG_ACR_CREDENTIAL_PROVIDER}/azure-acr-credential-provider"
        chmod 755 /var/lib/kubelet/credential-provider/acr-credential-provider
        curl --retry 10 --retry-delay 5 -w "response status code is %{http_code}" -Lo /var/lib/kubelet/credential-provider-config.yaml "https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_BLOB_CONTAINER_NAME}/${IMAGE_TAG_ACR_CREDENTIAL_PROVIDER}/credential-provider-config.yaml"
        chmod 644 /var/lib/kubelet/credential-provider-config.yaml
      fi
- op: test
  path: /spec/preKubeadmCommands
  value: null
- op: add
  path: /spec/preKubeadmCommands
  value: []
- op: add
  path: /spec/preKubeadmCommands/-
  value:
    bash -c /tmp/oot-cred-provider.sh
- op: add
  path: /spec/preKubeadmCommands/-
  value:
    bash -c /tmp/kubeadm-bootstrap.sh
- op: add
  path: /spec/joinConfiguration/nodeRegistration/kubeletExtraArgs/image-credential-provider-bin-dir
  value:
    /var/lib/kubelet/credential-provider
- op: add
  path: /spec/joinConfiguration/nodeRegistration/kubeletExtraArgs/image-credential-provider-config
  value:
    /var/lib/kubelet/credential-provider-config.yaml
