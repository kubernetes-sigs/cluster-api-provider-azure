kind: KubeadmControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
metadata:
  name: "${CLUSTER_NAME}-control-plane"
spec:
  kubeadmConfigSpec:
    preKubeadmCommands:
    - |
      # Install ca-certificates packages for Azure Linux
      tdnf install -y ca-certificates ca-certificates-legacy
      update-ca-trust
      
      # Create compatibility symlinks that many container applications expect
      mkdir -p /etc/ssl/certs
      
      # Create symlinks for common certificate paths
      ln -sf /etc/pki/tls/certs/ca-bundle.crt /etc/ssl/certs/ca-certificates.crt
      ln -sf /etc/pki/tls/certs/ca-bundle.crt /etc/ssl/certs/ca-bundle.crt
      
      # Stop kubelet to prevent startup race conditions during bootstrap
      systemctl stop kubelet || true
      systemctl disable kubelet || true
    postKubeadmCommands:
    - |
      # Re-enable and restart kubelet after kubeadm completes
      systemctl enable kubelet
      systemctl restart kubelet
    clusterConfiguration:
      controllerManager:
        extraArgs:
          v: "4"
