apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: KubeadmControlPlane
metadata:
  name: "${CLUSTER_NAME}-control-plane"
  annotations:
    controlplane.cluster.x-k8s.io/skip-kube-proxy: "true"
spec:
  kubeadmConfigSpec:
    verbosity: 5
    clusterConfiguration:
      kubernetesVersion: "ci/${CI_VERSION}"
    preKubeadmCommands:
    - bash -c /tmp/replace-k8s-binaries.sh
    files:
    - path: /tmp/replace-k8s-binaries.sh
      owner: "root:root"
      permissions: "0744"
      content: |
        #!/bin/bash

        set -o nounset
        set -o pipefail
        set -o errexit
        [[ $(id -u) != 0 ]] && SUDO="sudo" || SUDO=""

        # This test installs release packages or binaries that are a result of the CI and release builds.
        # It runs '... --version' commands to verify that the binaries are correctly installed
        # and finally uninstalls the packages.
        # For the release packages it tests all versions in the support skew.
        LINE_SEPARATOR="*************************************************"
        echo "$${LINE_SEPARATOR}"
        CI_VERSION=${CI_VERSION}

        CI_DIR=/tmp/k8s-ci
        mkdir -p "$${CI_DIR}"

        systemctl stop kubelet
        declare -a PACKAGES_TO_TEST=("kubectl" "kubelet" "kubeadm")
        # Let's just also download the control plane images for worker nodes. It's easier then optimizing it.
        declare -a CONTAINERS_TO_TEST=("kube-apiserver" "kube-controller-manager" "kube-proxy" "kube-scheduler")
        CONTAINER_EXT="tar"
        echo "* testing version $${CI_VERSION}"
        az login --identity
        for CI_PACKAGE in "$${PACKAGES_TO_TEST[@]}"; do
            echo "* downloading binary: https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_BLOB_CONTAINER_NAME}/${KUBE_GIT_VERSION}/bin/linux/amd64/$${CI_PACKAGE}"
            az storage blob download --blob-url "https://${AZURE_STORAGE_ACCOUNT}.blob.core.windows.net/${AZURE_BLOB_CONTAINER_NAME}/${KUBE_GIT_VERSION}/bin/linux/amd64/$${CI_PACKAGE}" -f "$${CI_DIR}/$${CI_PACKAGE}" --auth-mode login
            chmod +x "$${CI_DIR}/$${CI_PACKAGE}"
            mv "$${CI_DIR}/$${CI_PACKAGE}" "/usr/bin/$${CI_PACKAGE}"
        done

        systemctl restart kubelet
        IMAGE_REGISTRY_PREFIX=registry.k8s.io
        # Kubernetes builds from 1.20 through 1.24 are tagged with k8s.gcr.io
        if [[ "$${CI_VERSION}" =~ ^v1\.(1[0-9]|2[0-4])[\.[0-9]+ ]]; then
            IMAGE_REGISTRY_PREFIX=k8s.gcr.io
        fi
        for CI_CONTAINER in "$${CONTAINERS_TO_TEST[@]}"; do
            echo "* downloading container image: ${REGISTRY}/kube-apiserver:${KUBE_IMAGE_TAG}"
            $${SUDO} ctr -n k8s.io images pull "${REGISTRY}/$${CI_CONTAINER}:${KUBE_IMAGE_TAG}"
            $${SUDO} ctr -n k8s.io images tag "${REGISTRY}/$${CI_CONTAINER}:${KUBE_IMAGE_TAG}" "$${IMAGE_REGISTRY_PREFIX}/$${CI_CONTAINER}:$${CI_VERSION//+/_}"
            $${SUDO} ctr -n k8s.io images tag "${REGISTRY}/$${CI_CONTAINER}:${KUBE_IMAGE_TAG}" "gcr.io/k8s-staging-ci-images/$${CI_CONTAINER}:$${CI_VERSION//+/_}"
        done
        echo "* checking binary versions"
        echo "ctr version: " "$(ctr version)"
        echo "kubeadm version: " "$(kubeadm version -o=short)"
        echo "kubectl version: " "$(kubectl version --client=true)"
        echo "kubelet version: " "$(kubelet --version)"
        echo "$${LINE_SEPARATOR}"
    - path: /etc/kubernetes/azure.json
      owner: "root:root"
      permissions: "0644"
      contentFrom:
        secret:
          key: control-plane-azure.json
          name: ${CLUSTER_NAME}-control-plane-azure-json
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AzureMachineTemplate
metadata:
  name: ${CLUSTER_NAME}-control-plane
spec:
  template:
    spec:
      image:
        # we use the latest image as a workaround there is no published marketplace image for k8s CI versions.
        # latest binaries and images will get replaced to the desired version by the script above.
        computeGallery:
          gallery: ClusterAPI-f72ceb4f-5159-4c26-a0fe-2ea738f0d019
          name: capi-ubun2-2404
          version: latest
