name: Update Tool Versions

on:
    schedule:
      - cron: '0 0 * * 0'
    workflow_dispatch:

jobs:
    update-tools:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        steps:
            - uses: actions/checkout@v4

            - name: Install yq, jq and gh
              run: |
                sudo apt-get update && sudo apt-get install -y jq
                curl -sL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq
                chmod +x /usr/local/bin/yq
                curl -sL https://github.com/cli/cli/releases/download/v2.49.0/gh_2.49.0_linux_amd64.tar.gz | tar xz
                sudo cp gh_*/bin/gh /usr/local/bin/

            - name: Create PRs for Updated Tools
              env:
                GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                set -euo pipefail
                file="hack/tools/tools.yaml"
                tools=$(yq eval '.tools | keys | .[]' $file)

                get_latest_release() {
                    local repo=$1
                    curl -s "https://api.github.com/repos/$repo/releases/latest" | jq -r .tag_name
                }

                get_kustomize_latest_release() {
                    local repo=$1
                    curl -s https://api.github.com/repos/$repo/releases/latest | jq -r '.tag_name' | sed 's|.*/||'
                }

                get_conversion_gen_latest_release() {
                    local repo=$1
                    curl -s "https://api.github.com/repos/kubernetes/code-generator/tags?per_page=100" | jq -r '.[].name' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' |sort -V | tail -n1
                }

                declare -A repos=(
                    [controller-gen]="kubernetes-sigs/controller-tools"
                    [conversion-gen]="kubernetes/code-generator"
                    [kustomize]="kubernetes-sigs/kustomize"
                    [azwi]="Azure/azure-workload-identity"
                    [mockgen]="golang/mock"
                    [release-notes]="kubernetes/release"
                    [kubectl]="kubernetes/kubernetes"
                    [helm]="helm/helm"
                    [yq]="mikefarah/yq"
                    [kind]="kubernetes-sigs/kind"
                    [codespell]="codespell-project/codespell"
                )

                for tool in "${!repos[@]}"; do
                    repo="${repos[$tool]}"
                    current=$(yq ".tools.$tool" $file)

                    if [[ "$tool" == "kubectl" ]]; then
                    latest="$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)"
                    elif [[ "$tool" == "kustomize" ]]; then
                    latest=$(get_kustomize_latest_release)
                    elif [[ "$tool" == "conversion-gen" ]]; then
                    latest=$(get_conversion_gen_latest_release)
                    else
                    latest=$(get_latest_release $repo)
                    fi

                    if [[ "$current" != "$latest" ]]; then
                    branch="update-tool-$tool-$latest"
                    echo "Updating $tool from $current to $latest"
                    git checkout -b "$branch"
                    yq -i ".tools.$tool = \"$latest\"" "$file"
                    git config user.name "github-actions[bot]"
                    git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                    git add "$file"
                    git commit -m "dependency: bump $tool to $latest"
                    git push origin "$branch" --force

                    gh pr create \
                        --title "[dependency] bump $tool to $latest" \
                        --body "This PR updates \`$tool\` from \`$current\` to \`$latest\`." \
                        --base main \
                        --label "dependencies,area/dependency,release-note/none,ok-to-test" \
                        --head "$branch"
                    else
                    echo "$tool is already up to date ($current)"
                    fi

                    git checkout main
                    git reset --hard origin/main
                    git clean -fd
                done
